# Hookah Spliter

Мини-приложение для ведения кальянных сессий с интеграцией в Telegram Mini Apps.

## Локальный запуск

1. **Установите зависимости.** Нужен Node.js 18+. Дополнительных npm-пакетов нет, поэтому достаточно клонировать репозиторий.
2. **Подготовьте переменные окружения.**
   - `JWT_SECRET` — произвольная строка для подписи токенов (в dev можно оставить значение по умолчанию `dev-secret-token`).
   - `BOT_TOKEN` — токен Telegram-бота. Для офлайн-режима можно оставить пустым, тогда сервер не будет проверять подпись `initData` и уведомления отправятся в лог.
   Можно задать переменные через `.env` (используйте `export $(cat .env | xargs)` перед запуском) или напрямую в терминале.
3. **Убедитесь, что в каталоге `data/` существуют файлы `users.json`, `sessions.json`, `logs.json`.** Они уже лежат в репозитории; при отсутствии будут созданы автоматически.
4. **Запустите backend:**
   ```bash
   node server.js
   ```
   По умолчанию сервер слушает `http://localhost:4000`.
5. **Поднимите статический хостинг фронтенда.** Проще всего открыть отдельный терминал и выполнить:
   ```bash
   npx serve .
   ```
   или
   ```bash
   python3 -m http.server 5173
   ```
   После этого страница будет доступна, например, по `http://localhost:3000` (для `serve`).
6. **Протестируйте без Telegram.** Добавьте к URL параметр `?devUser=%7B%22id%22%3A%22demo%22%2C%22username%22%3A%22demo%22%7D`, чтобы эмулировать ответ Telegram WebApp.
7. **Интегрируйтесь с Telegram Mini App.**
   - Создайте бота через [BotFather](https://t.me/botfather) и укажите `Web App` URL, ведущий на вашу страницу.
   - Запустите мини-приложение из клиента Telegram — после авторизации появится полноценный интерфейс.

## Бесплатные варианты развёртывания

### Статика фронтенда

Да, `index.html`, `styles.css` и `main.js` можно разместить на GitHub Pages:

1. Создайте ветку/репозиторий и поместите файлы в корень.
2. В настройках GitHub включите Pages из ветки `main` (папка `/`).
3. Укажите получившийся URL в настройках WebApp бота.

Альтернативы: Cloudflare Pages или Netlify (у них есть бесплатный тариф и автоматический деплой из GitHub).

### Backend на Node.js

Поскольку сервер хранит данные в JSON-файлах, требуется платформа с постоянным диском. Подойдут:

- **Render (Free Web Service)** — можно задать `node server.js` как команду запуска и подключить бесплатный диск до 1 ГБ; файлы будут сохраняться в каталоге `data/`.
- **Railway** — бесплатный тариф с 500 часов в месяц. Создайте Node.js сервис, прикрепите Volume и смонтируйте его в `/workspace/data` (либо используйте переменную `DATA_DIR`, если измените код).
- **Fly.io** — позволяет запускать приложения в Docker-контейнере и подключать `fly volumes` для хранения. Подготовьте `Dockerfile`, смонтируйте Volume в `/data` и укажите переменные окружения.

При деплое обязательно задайте `JWT_SECRET` и `BOT_TOKEN` в настройках окружения, а также позаботьтесь об HTTPS-адресе — именно его потребуется указать в настройках WebApp.

### Тестовый туннель

Для локальной отладки удобно использовать [ngrok](https://ngrok.com/) или [LocalTunnel](https://localtunnel.github.io/www/), чтобы пробросить HTTPS URL вашего фронтенда и backend’а в Telegram без полноценного деплоя. Подключите туннель к порту статического сервера и пропишите URL в BotFather.

## Возможности

- Авторизация через Telegram Web App и файл-ориентированное хранилище.
- Управление сессиями и чашами только администраторами.
- Привязка участников к их Telegram-аккаунтам.
- Уведомления о добавлении в чашу (через Telegram Bot API или консоль в dev-режиме).
- Журнал действий администратора с просмотром в настройках.
